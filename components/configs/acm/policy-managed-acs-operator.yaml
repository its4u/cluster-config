apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-managed-acs-operator
  namespace: openshift-gitops
  annotations:
    policy.open-cluster-management.io/categories: CM Configuration Management, CA Security Assessment and Authorization
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration, CA-2
      Security Assessments, CA-7 Continuous Monitoring
    policy.open-cluster-management.io/standards: NIST SP 800-53
spec:
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: stackrox-operator-ns
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Namespace
                metadata:
                  name: stackrox
          remediationAction: inform
          severity: high
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: rhacs-operator-ns
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Namespace
                metadata:
                  name: rhacs-operator
          remediationAction: inform
          severity: high
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: rhacs-operator-group
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: operators.coreos.com/v1
                kind: OperatorGroup
                metadata:
                  name: rhacs-operator
                  namespace: stackrox
                spec:
                  targetNamespaces:
                    - rhacs-operator
          remediationAction: inform
          severity: high
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: acs-operator-subscription
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: operators.coreos.com/v1alpha1
                kind: Subscription
                metadata:
                  name: rhacs-operator
                  namespace: rhacs-operator
                spec:
                  channel: latest
                  name: rhacs-operator
                  installPlanApproval: Automatic
                  source: redhat-operators
                  sourceNamespace: openshift-marketplace
                  startingCSV: rhacs-operator.v3.73.0
          remediationAction: inform
          severity: high
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: acs-operator-status
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: operators.coreos.com/v1alpha1
                kind: ClusterServiceVersion
                metadata:
                  namespace: rhacs-operator
                spec:
                  displayName: Advanced Cluster Security for Kubernetes
                status:
                  phase: Succeeded
          remediationAction: inform
          severity: high
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: acs-secured-cluster-name-secret
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Secret
                metadata:
                  name: acs-secured-cluster-name-secret
                  namespace: stackrox
                stringData:
                  acs-cluster-name: '{{ fromClusterClaim "gitops" }}'
          remediationAction: inform
          severity: high
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: acs-secured-cluster-bootstrap-application-present
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: argoproj.io/v1alpha1
                kind: Application
                metadata:
                  name: acs-secured-cluster-bootstrap
                  namespace: openshift-gitops
                spec:
                  destination:
                    namespace: openshift-gitops
                    server: https://kubernetes.default.svc
                  project: default
                  source:
                    path: components/apps/acs-secured-cluster/base
                    repoURL: https://github.com/kevbrain/cluster-config.git
                    targetRevision: HEAD
                  syncPolicy:
                    automated:
                      prune: false
                      selfHeal: true
          remediationAction: inform
          severity: high
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: acs-secured-cluster-service-present
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: platform.stackrox.io/v1alpha1
                kind: SecuredCluster
                metadata:
                  name: stackrox-secured-cluster-services
                  namespace: stackrox
                spec:
                  admissionControl:
                    nodeSelector:
                      node-role.kubernetes.io/infra: ''
                    listenOnUpdates: true
                    resources:
                      limits:
                        cpu: 500m
                        memory: 500Mi
                      requests:
                        cpu: 50m
                        memory: 100Mi
                    bypass: BreakGlassAnnotation
                    contactImageScanners: DoNotScanInline
                    listenOnCreates: true
                    tolerations:
                      - effect: NoSchedule
                        key: infra
                        value: reserved
                      - effect: NoExecute
                        key: infra
                        value: reserved
                    timeoutSeconds: 20
                    listenOnEvents: true
                  auditLogs:
                    collection: Auto
                  centralEndpoint: 'central-rhacs-operator.apps.ocp-lab2.its4u.eu:443'
                  clusterName: '{{ fromClusterClaim "gitops" }}'
                  perNode:
                    collector:
                      collection: KernelModule
                      imageFlavor: Regular
                      resources:
                        limits:
                          cpu: 750m
                          memory: 1Gi
                        requests:
                          cpu: 50m
                          memory: 320Mi
                    taintToleration: TolerateTaints
                  scanner:
                    analyzer:
                      nodeSelector:
                        node-role.kubernetes.io/infra: ''
                      resources:
                        limits:
                          cpu: '5'
                          memory: 8Gi
                        requests:
                          cpu: '1.2'
                          memory: 2700Mi
                      scaling:
                        autoScaling: Enabled
                        maxReplicas: 5
                        minReplicas: 2
                        replicas: 3
                      tolerations:
                        - effect: NoSchedule
                          key: infra
                          value: 
                        - effect: NoExecute
                          key: infra
                          value: 
                    db:
                      nodeSelector:
                        node-role.kubernetes.io/infra: ''
                      tolerations:
                        - effect: NoExecute
                          key: infra
                          value: 
                        - effect: NoSchedule
                          key: infra
                          value: 
                    scannerComponent: AutoSense
                  sensor:
                    nodeSelector:
                      node-role.kubernetes.io/infra: ''
                    resources:
                      limits:
                        cpu: '2'
                        memory: 4Gi
                      requests:
                        cpu: '1'
                        memory: 1Gi
                    tolerations:
                      - effect: NoSchedule
                        key: infra
                        value: 
                      - effect: NoExecute
                        key: infra
                        value: 
          remediationAction: inform
          severity: high
  remediationAction: enforce
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: placement-policy-acs-securedcluster
  namespace: openshift-gitops
spec:
  clusterConditions:
    - status: "True"
      type: ManagedClusterConditionAvailable
  clusterSelector:
    matchExpressions:
      - key: acs
        operator: In
        values:
        - secured
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: policy-managed-acs-operator-placement-binding
  namespace: openshift-gitops
placementRef:
  name: placement-policy-acs-securedcluster
  apiGroup: apps.open-cluster-management.io
  kind: PlacementRule
subjects:
  - name: policy-managed-acs-operator
    apiGroup: policy.open-cluster-management.io
    kind: Policy
